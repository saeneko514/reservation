<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>スタッフ選択と空き枠予約</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <h1>スタッフを選んでください</h1>
    <select id="staffSelect">
      <option value="">-- スタッフ選択 --</option>
      <option value="A">A</option>
      <option value="B">B</option>
      <option value="C">C</option>
    </select>

    <div id="slotContainer" style="display:none;">
      <h2 id="selectedStaff"></h2>
      <ul id="slotList" class="slot-list"></ul>
    </div>

    <form id="hiddenForm" method="POST" action="/book" style="display:none;">
      <input type="hidden" name="staff" />
      <input type="hidden" name="datetime" />
      <input type="hidden" name="userName" />
      <input type="hidden" name="userId" />
    </form>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    let userName = "";
    let userId = "";

    liff.init({ liffId: "2007657386-9m3VArgZ" })
      .then(() => Promise.all([liff.getProfile(), liff.getDecodedIDToken()]))
      .then(([profile, decoded]) => {
        userName = profile.displayName;
        userId = decoded.sub;
      })
      .catch(err => {
        console.error("LIFF初期化エラー:", err);
        alert("LINEログイン情報の取得に失敗しました。再読み込みしてください。");
      });

    document.getElementById("staffSelect").addEventListener("change", function () {
      const staff = this.value;
      if (!staff) {
        document.getElementById("slotContainer").style.display = "none";
        return;
      }

      fetch(`/api/available_slots?staff=${encodeURIComponent(staff)}`)
        .then((res) => res.json())
        .then((data) => {
          const slots = data.slots;
          const slotList = document.getElementById("slotList");
          slotList.innerHTML = "";
          document.getElementById("selectedStaff").textContent = `${staff}の予約可能時間`;
          document.getElementById("slotContainer").style.display = "block";

          if (slots.length === 0) {
            slotList.innerHTML = "<li>現在、空き枠はありません。</li>";
          } else {
            slots.forEach((slot) => {
              const li = document.createElement("li");
              const btn = document.createElement("button");
              btn.textContent = slot;
              btn.addEventListener("click", () => {
                submitBooking(staff, slot);
              });
              li.appendChild(btn);
              slotList.appendChild(li);
            });
          }
        })
        .catch(() => {
          alert("空き枠の取得に失敗しました。");
        });
    });

    function submitBooking(staff, datetime) {
      const form = document.getElementById("hiddenForm");
      form.staff.value = staff;
      form.datetime.value = datetime;
      form.userName.value = userName;
      form.userId.value = userId;
      form.submit();
    }
  </script>
</body>
</html>
